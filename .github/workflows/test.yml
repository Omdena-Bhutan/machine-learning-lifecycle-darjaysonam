name: test

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  pytest:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r app/requirements.txt
          pip install pytest

      - name: Create dummy model for tests
        run: |
          python - <<'PY'
          from pathlib import Path
          import joblib
          from sklearn.pipeline import Pipeline
          from sklearn.feature_extraction.text import TfidfVectorizer
          from sklearn.linear_model import LogisticRegression

          out_dir = Path("tests/assets")
          out_dir.mkdir(parents=True, exist_ok=True)

          X = ["good movie", "bad movie", "excellent film", "terrible film"]
          y = [1, 0, 1, 0]

          model = Pipeline([
              ("tfidf", TfidfVectorizer()),
              ("clf", LogisticRegression(max_iter=200))
          ])
          model.fit(X, y)

          out = out_dir / "model.pkl"
          joblib.dump(model, out)
          print("Saved:", out)
          PY

      - name: Run tests
        env:
          MODEL_FILE: tests/assets/model.pkl
        run: |
          pytest -q
